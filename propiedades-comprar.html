<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Altorra — Propiedades en Venta</title>
<meta name="description" content="Compra de propiedades con Altorra: atención personalizada y asesoría jurídica."/>
<!-- PWA y metadatos de redes sociales -->
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#d4af37"/>
<meta property="og:title" content="Propiedades en venta | Altorra"/>
<meta property="og:description" content="Descubre las mejores propiedades en venta en Cartagena y otras ciudades. Filtra por ciudad, tipo y precio con Altorra."/>
<meta property="og:image" content="/img/uploads/comprar1.png"/>
<link rel="stylesheet" href="style.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;800&display=swap" rel="stylesheet"/>

<style>
:root{--card-radius:14px;--badge-h:28px;}
main{padding-top:calc(var(--header-h) + 12px);max-width:var(--page-max);margin:0 auto}
  .filters{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;padding:12px 16px;background:#fff;border-radius:12px;margin:16px;border:1px solid rgba(0,0,0,.06)}
  .filters .control{display:flex;flex-direction:column;gap:6px}
  .filters label{font-weight:700;font-size:.85rem;color:var(--muted)}
  .filters input[type="text"], .filters select, .filters input[type="number"]{padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.08);min-width:160px}
  .filters .actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{padding:10px 14px;border-radius:10px;font-weight:800;border:0}
  .btn-primary{background:linear-gradient(90deg,var(--accent),#ffd95e);color:#111;box-shadow:0 10px 22px rgba(0,0,0,.08)}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,.08);color:var(--text)}

  .grid{display:grid;gap:18px;padding:16px;grid-template-columns:repeat(3,1fr)}
  @media (max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:720px){ .grid{grid-template-columns:1fr} }

  .card{background:#fff;border-radius:var(--card-radius);overflow:hidden;border:1px solid rgba(0,0,0,.06);
    box-shadow:0 8px 24px rgba(0,0,0,.06);display:flex;flex-direction:column;transition:transform .18s ease, box-shadow .18s ease}
  .card:hover{transform:translateY(-4px);box-shadow:0 16px 36px rgba(0,0,0,.12)}

  .media{position:relative;overflow:hidden;background:#f5f5f5}
  .media::before{content:"";display:block;padding-top:75%} /* 4:3 fallback */
  .media{aspect-ratio:4/3}
  .placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;color:#7a7a7a;font-size:1.05rem}
  .placeholder span{background:#fff;border:1px dashed #d0d0d0;border-radius:10px;padding:6px 10px;opacity:.9}
  /* Mostrar imágenes en las tarjetas */
  .media img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
  }
  /* Cambiar cursor y animación al pasar sobre la tarjeta */
  .card{cursor:pointer;}

  .badges{position:absolute;left:10px;top:10px;display:flex;gap:6px;flex-wrap:wrap;max-width:calc(100% - 64px)}
  .badge{
    height:var(--badge-h);display:inline-flex;align-items:center;gap:6px;padding:0 10px;border-radius:999px;
    font-size:12px;font-weight:800;letter-spacing:.2px;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
    border:1px solid rgba(0,0,0,.06);white-space:nowrap;line-height:var(--badge-h)
  }
  .badge--dark{background:rgba(17,24,39,.9);color:#fff}
  .fav-btn{position:absolute;top:10px;right:10px;background:rgba(255,255,255,.95);border-radius:999px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border:0;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .fav-btn .heart{font-size:18px;color:#b7b7b7;transition:transform .12s ease,color .12s ease}
  .fav-btn[aria-pressed="true"] .heart{color:var(--accent);transform:scale(1.07)}

  .meta{padding:12px 14px;display:flex;flex-direction:column;gap:8px}
  .meta h3{margin:0;font-size:1.05rem;line-height:1.2;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.4em}
  .price{font-weight:900;color:var(--gold);font-size:1.05rem}
  .specs{color:var(--muted);font-size:.95rem}

  /* ---------- CTA (AJUSTE: que quepan en 1 sola linea y sean simétricos) ---------- */
  .cta{
    display:flex;
    gap:8px;
    margin-top:8px;
    flex-wrap:nowrap;
    align-items:center;
    justify-content:stretch;
  }
  .cta .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    flex:1 1 0;
    min-width:0;
    padding:8px 10px;
    font-size:0.92rem;
    line-height:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    border-radius:10px;
  }
  .cta .btn-primary{ background:linear-gradient(90deg,var(--accent),#ffd95e); color:#111; box-shadow:0 8px 18px rgba(0,0,0,.08); border:0; }
  .cta .btn-ghost{ background:transparent; border:1px solid rgba(0,0,0,.08); color:var(--text); }
  .cta a.btn{display:inline-flex}

  @media (max-width:480px){ .cta .btn{padding:6px 8px;font-size:0.84rem} }

  /* ---------- MODAL CONTACTO ---------- */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);display:none;z-index:500}
  .modal-backdrop.open{display:block}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(720px,92vw);background:#fff;border-radius:16px;border:1px solid rgba(0,0,0,.06);box-shadow:0 24px 64px rgba(0,0,0,.22);display:none;z-index:501}
  .modal.open{display:block}
  .modal header{all:unset;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.06)}
  .modal h3{margin:0;font-weight:800}
  .modal .close{background:transparent;border:0;font-size:20px;cursor:pointer}
  .modal .content{padding:14px 16px}
  .lead-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){ .lead-grid{grid-template-columns:1fr} }
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-weight:700;font-size:.9rem;color:var(--muted)}
  .field input,.field textarea, .field select{padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.08)}
  .field textarea{min-height:96px;resize:vertical}
  .modal footer{padding:14px 16px;border-top:1px solid rgba(0,0,0,.06);display:flex;gap:10px;justify-content:flex-end}
  .note{color:#6b7280;font-size:.85rem}

    /* ---------- FOOTER ---------- */
  footer{background:#0b0b0b;color:#fff;padding:36px 16px}
  .footer-grid{max-width:var(--page-max);margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
  @media (max-width:920px){ .footer-grid{grid-template-columns:1fr} }

  @media (max-width:920px){ .footer-grid{grid-template-columns:1fr} }
footer{background:#0b0b0b;color:#fff;padding:36px 16px}
.footer-grid{max-width:var(--page-max);margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
@media (max-width:920px){.footer-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <a href="#main" class="skip-link">Saltar al contenido principal</a>
  <div id="header-placeholder"></div>
  <!-- Registrar service worker para PWA -->
  <script>
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("/service-worker.js").catch(function(err){ console.warn("SW registration failed", err); });
    }
  </script>
  <main id="main" style="padding-bottom:32px">
<!-- FILTROS -->
  <section class="filters" aria-label="Filtros de búsqueda">
    <div class="control">
      <label for="f-city">Ciudad</label>
      <input id="f-city" type="text" placeholder="Ej. Cartagena"/>
    </div>
    <div class="control">
      <label for="f-type">Tipo</label>
      <select id="f-type">
        <option value="">Cualquiera</option>
        <option value="apartamento">Apartamento</option>
        <option value="casa">Casa</option>
        <option value="lote">Lote</option>
        <option value="oficina">Oficina</option>
      </select>
    </div>
    <div class="control">
      <label for="f-min">Precio min (COP)</label>
      <input id="f-min" type="number" min="0" placeholder="0"/>
    </div>
    <div class="control">
      <label for="f-max">Precio max (COP)</label>
      <input id="f-max" type="number" min="0" placeholder="—"/>
    </div>
    <div class="control">
      <label for="f-sort">Ordenar</label>
      <select id="f-sort">
        <option value="relevance">Relevancia</option>
        <option value="price-asc">Precio ↑</option>
        <option value="price-desc">Precio ↓</option>
      </select>
    </div>
    <div class="actions">
      <button id="btnClear" class="btn btn-ghost" type="button">Limpiar</button>
      <button id="btnApply" class="btn btn-primary" type="button">Aplicar filtros</button>
    </div>
  </section>

  <!-- GRID -->
  <section aria-label="Resultados">
    <div id="list" class="grid" role="list" aria-live="polite"></div>
    <div style="display:flex;justify-content:center;margin:22px">
      <button id="btnLoadMore" class="btn btn-ghost" style="padding:12px 20px">Cargar más</button>
    </div>
  </section>
  </main>
<div id="leadBackdrop" class="modal-backdrop" aria-hidden="true"></div>
<section id="leadModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="leadTitle" hidden>
  <header>
    <h3 id="leadTitle">Contacto</h3>
    <button class="close" type="button" aria-label="Cerrar">✕</button>
  </header>
  <div class="content">
    <form id="leadForm" method="POST" target="leadTarget">
      <div class="lead-grid">
        <div class="field">
          <label for="lead-name">Nombre completo</label>
          <input id="lead-name" name="entry.name" type="text" placeholder="Tu nombre" required/>
        </div>
        <div class="field">
          <label for="lead-phone">Teléfono</label>
          <input id="lead-phone" name="entry.phone" type="tel" placeholder="+57 ..." required/>
        </div>
        <div class="field">
          <label for="lead-email">Correo</label>
          <input id="lead-email" name="entry.email" type="email" placeholder="tucorreo@email.com" required/>
        </div>
        <div class="field">
          <label for="lead-date">Fecha</label>
          <input id="lead-date" name="entry.date" type="datetime-local" required/>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label for="lead-property">Propiedad de interés</label>
          <input id="lead-property" name="entry.property" type="text" readonly/>
          <input id="lead-url" name="entry.url" type="hidden"/>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label for="lead-message">Mensaje</label>
          <textarea id="lead-message" name="entry.message" placeholder="Cuéntanos qué necesitas..."></textarea>
        </div>
      </div>
      <p class="note" style="margin-top:8px">Protegemos tus datos. Un asesor te contactará muy pronto.</p>

      <!-- Campos ocultos para Google Forms -->
      <input type="hidden" id="g-name"     />
      <input type="hidden" id="g-phone"    />
      <input type="hidden" id="g-email"    />
      <input type="hidden" id="g-date"     />
      <input type="hidden" id="g-property" />
      <input type="hidden" id="g-url"      />
      <input type="hidden" id="g-message"  />
    </form>
  </div>
  <footer>
    <button class="btn btn-ghost" type="button" id="leadCancel">Cancelar</button>
    <button class="btn btn-primary" type="button" id="leadSubmit">Enviar</button>
  </footer>
</section>
<iframe name="leadTarget" id="leadTarget" style="display:none"></iframe>
  <div id="footer-placeholder"></div>
  <script src="header-footer.js" defer></script>
  <script>
/* ---------------- Helpers ---------------- */
const isTouch = () => window.matchMedia('(hover: none)').matches || 'ontouchstart' in window;
function formatCOP(n){ return (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
function capitalize(s){ s=String(s||''); return s.charAt(0).toUpperCase()+s.slice(1); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ---------------- Desktop menu manager (copied del home) ---------------- */
(function(){
  const MARGIN = 12;
  let open = null;
  const supportsHover = window.matchMedia('(hover: hover)').matches;

  function resetPanelStyles(panel){
    panel.style.left=''; panel.style.top=''; panel.style.width=''; panel.style.maxWidth=''; panel.style.right='';
  }
  function placeAndShow(btn, panel, size){
    if(window.innerWidth <= 860) return;
    if(open && open.panel !== panel) hideImmediate(open);

    resetPanelStyles(panel);
    panel.style.display = 'block';
    panel.style.visibility = 'hidden';
    panel.style.position = 'fixed';
    panel.style.maxHeight = Math.max(260, window.innerHeight - (MARGIN*2)) + 'px';

    if(size === 'mega'){
      panel.style.width = Math.min(920, window.innerWidth - (MARGIN*2)) + 'px';
    } else {
      panel.style.width = 'auto';
      panel.style.maxWidth = Math.min(520, window.innerWidth - (MARGIN*2)) + 'px';
    }

    const preRect = panel.getBoundingClientRect();
    const bRect = btn.getBoundingClientRect();

    let left;
    if(size === 'mega'){
      left = Math.round(bRect.left + bRect.width/2 - preRect.width/2);
      left = Math.max(MARGIN, Math.min(left, window.innerWidth - preRect.width - MARGIN));
    } else {
      left = Math.round(Math.min(bRect.left, window.innerWidth - preRect.width - MARGIN));
      left = Math.max(left, MARGIN);
    }

    let top = Math.round(bRect.bottom + 8);
    if(top + preRect.height > window.innerHeight - MARGIN){
      top = Math.round(bRect.top - preRect.height - 8);
      if(top < MARGIN) top = MARGIN;
    }

    panel.style.left = left + 'px';
    panel.style.top = top + 'px';
    panel.style.visibility = 'visible';
    panel.classList.add('menu-visible');
    panel.setAttribute('aria-hidden','false');
    btn.setAttribute('aria-expanded','true');
    open = {panel, btn};
  }
  function hideImmediate(obj){
    if(!obj) return;
    obj.btn && obj.btn.setAttribute('aria-expanded','false');
    obj.panel.classList.remove('menu-visible');
    obj.panel.style.display = 'none';
    obj.panel.setAttribute('aria-hidden','true');
    resetPanelStyles(obj.panel);
    if(open && open.panel === obj.panel) open = null;
  }

  document.querySelectorAll('.nav-btn[data-panel]').forEach(btn=>{
    const panelId = btn.getAttribute('data-panel');
    const panel = document.getElementById(panelId);
    const item = btn.closest('.nav-item');
    const size = item ? (item.dataset.size || 'compact') : 'compact';
    let openTimer=null, closeTimer=null;
    const show = ()=> { clearTimeout(closeTimer); openTimer = setTimeout(()=>{ placeAndShow(btn, panel, size); }, 60); };
    const hide = ()=> { clearTimeout(openTimer); closeTimer = setTimeout(()=>{ hideImmediate({panel, btn}); }, 120); };
    if(supportsHover){
      btn.addEventListener('pointerenter', show);
      btn.addEventListener('pointerleave', hide);
      panel.addEventListener('pointerenter', ()=> { clearTimeout(closeTimer); clearTimeout(openTimer); });
      panel.addEventListener('pointerleave', hide);
    }
    btn.addEventListener('click', (e)=> {
      if(window.innerWidth > 860){
        e.preventDefault();
        if(panel.classList.contains('menu-visible')) hideImmediate({panel, btn});
        else placeAndShow(btn, panel, size);
      }
    });
    btn.addEventListener('focus', show);
    btn.addEventListener('blur', ()=> setTimeout(()=>{ if(!panel.contains(document.activeElement)) hide(); }, 60));
  });

  document.addEventListener('click', (e)=>{
    if(e.target.closest('nav') || e.target.closest('.menu-panel')) return;
    document.querySelectorAll('.menu-panel.menu-visible').forEach(p=> hideImmediate({panel:p, btn:null}));
  });
  document.addEventListener('keydown', (e)=> {
    if(e.key === 'Escape'){
      document.querySelectorAll('.menu-panel.menu-visible').forEach(p=> hideImmediate({panel:p, btn:null}));
    }
  });
  window.addEventListener('resize', ()=> {
    document.querySelectorAll('.menu-panel').forEach(p=> { p.classList.remove('menu-visible'); p.style.display='none'; p.setAttribute('aria-hidden','true'); resetPanelStyles(p); });
    document.querySelectorAll('.nav-btn[data-panel]').forEach(b => b.setAttribute('aria-expanded','false'));
    open = null;
  });
})();

/* ---------------- Drawer móvil ---------------- */
(function(){
  const toggle = document.getElementById('navToggle');
  const drawer = document.getElementById('mobileMenu');
  const backdrop = document.getElementById('drawerBackdrop');
  if(!toggle || !drawer || !backdrop) return;

  let lastFocus = null;
  function focusable(root){ return root.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])'); }
  function setDrawerHeight(){
    const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 72;
    drawer.style.height = (window.innerHeight - headerH) + 'px';
  }
  function clearDrawerHeight(){ drawer.style.height = ''; }
  function openDrawer(){
    lastFocus = document.activeElement;
    drawer.hidden = false;
    setDrawerHeight();
    window.addEventListener('resize', setDrawerHeight);
    window.addEventListener('orientationchange', setDrawerHeight);
    requestAnimationFrame(()=> {
      drawer.classList.add('open');
      backdrop.classList.add('open');
      document.body.style.overflow='hidden';
      toggle.setAttribute('aria-expanded','true');
      const el = focusable(drawer)[0];
      el && el.focus();
    });
  }
  function closeDrawer(){
    drawer.classList.remove('open');
    backdrop.classList.remove('open');
    document.body.style.overflow='';
    toggle.setAttribute('aria-expanded','false');
    window.removeEventListener('resize', setDrawerHeight);
    window.removeEventListener('orientationchange', setDrawerHeight);
    setTimeout(()=> { drawer.hidden = true; clearDrawerHeight(); }, 200);
    lastFocus && lastFocus.focus();
  }
  toggle.addEventListener('click', ()=> drawer.classList.contains('open') ? closeDrawer() : openDrawer());
  backdrop.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', (e)=> {
    if(e.key === 'Escape' && !drawer.hidden) closeDrawer();
    if(e.key === 'Tab' && !drawer.hidden){
      const els = Array.from(focusable(drawer));
      if(els.length === 0) return;
      const first = els[0], last = els[els.length-1];
      if(e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    }
  });
  window.addEventListener('resize', ()=> { if(window.innerWidth > 860 && !drawer.hidden) closeDrawer(); });
})();

/* ---------------- PROPIEDADES: datos y render ---------------- */
document.addEventListener('DOMContentLoaded', function(){
  const WHATSAPP = { phone:'573235016747', company:'Altorra Inmobiliaria' };

  /*
   * The list of properties is now loaded from an external JSON file so that
   * new properties can be added without modifying HTML. The variable
   * `operation` defines the type of operation this page handles. Only
   * properties matching this value will be displayed. Valid values are
   * "comprar", "arrendar" or "dias".
   */
  let sampleProperties = [];
  const operation = 'comprar';

  // The JSON file is located at /properties/data.json and will be
  // fetched in the async init() function defined below.

  let renderedCount = 0;
  const PAGE_SIZE = 6;

  function buildWhatsAppLink(p){
    const detailsUrl = new URL('detalle-propiedad.html?id='+encodeURIComponent(p.id), location.href).href;
    const price = '$'+formatCOP(p.price)+' COP';
    const text = `Hola ${WHATSAPP.company}, me interesa la propiedad "${p.title}" (ID: ${p.id}) en ${p.city} por ${price}. ¿Podemos agendar una visita? Detalles: ${detailsUrl}`;
    return `https://wa.me/${WHATSAPP.phone}?text=${encodeURIComponent(text)}`;
  }

  function createCard(p){
    const card = document.createElement('article');
    card.className = 'card';
    card.setAttribute('role','listitem');
    card.innerHTML = `
      <div class="media">
        <img src="${escapeHtml(p.image ? (p.image.startsWith('/') ? p.image : '/' + p.image) : 'https://i.postimg.cc/0yYb8Y6r/placeholder.png')}" alt="${escapeHtml(p.title || 'Propiedad')}" loading="lazy" decoding="async"/>
        <div class="badges">
          <span class="badge"><small>Ciudad</small>&nbsp;${escapeHtml(p.city)}</span>
          <span class="badge badge--dark">${capitalize(p.type)}</span>
          ${p.sqm ? `<span class="badge">${p.sqm} m²</span>` : ``}
          ${(p.beds||0)>0 ? `<span class="badge">${p.beds}H · ${p.baths||0}B</span>` : ``}
        </div>
        <button class="fav-btn" type="button" aria-label="Guardar favorito" aria-pressed="false"><span class="heart">♡</span></button>
      </div>
      <div class="meta">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <h3>${escapeHtml(p.title)}</h3>
          <div class="price">$${formatCOP(p.price)} COP</div>
        </div>
        <div class="specs">${p.beds ? p.beds+'H · ' : ''}${p.baths? p.baths+'B · ' : ''}${p.sqm? p.sqm+' m² · ' : ''}${escapeHtml(p.city)} · ${capitalize(p.type)}</div>
        <div class="cta">
          <a class="btn btn-primary" href="detalle-propiedad.html?id=${encodeURIComponent(p.id)}">Ver detalles</a>
          <a class="btn btn-ghost" href="${buildWhatsAppLink(p)}" target="_blank" rel="noopener">WhatsApp</a>
        </div>
      </div>
    `;
    // favoritos
    const fav = card.querySelector('.fav-btn');
    fav && fav.addEventListener('click', (e)=>{
      const btn = e.currentTarget; const pressed = btn.getAttribute('aria-pressed')==='true';
      btn.setAttribute('aria-pressed', pressed ? 'false':'true');
      btn.querySelector('.heart').textContent = pressed ? '♡' : '♥';
      e.stopPropagation();
    });
    // No contact button; users can use WhatsApp or the contact form on the detalle de propiedad page
    // click card -> detalles (excepto CTAs/fav)
    card.addEventListener('click', (e)=> {
      if(e.target.closest('.cta') || e.target.closest('.fav-btn')) return;
      window.location.href = 'detalle-propiedad.html?id=' + encodeURIComponent(p.id);
    });
    return card;
  }

  function renderList(items, replace){
    const root = document.getElementById('list');
    if(!root) return;
    if(replace) root.innerHTML='';
    items.forEach(p=> root.appendChild(createCard(p)));
  }

  // filtros
  function applyFilters({city,type,min,max,sort}){
    let arr = sampleProperties.slice();
    if(city) arr = arr.filter(p=> p.city.toLowerCase().includes(city.toLowerCase()));
    if(type) arr = arr.filter(p=> p.type===type);
    if(min) arr = arr.filter(p=> p.price >= Number(min||0));
    if(max) arr = arr.filter(p=> p.price <= Number(max||Infinity));
    if(sort==='price-asc') arr.sort((a,b)=>a.price-b.price);
    if(sort==='price-desc') arr.sort((a,b)=>b.price-a.price);
    return arr;
  }

  const btnApply = document.getElementById('btnApply');
  const btnClear = document.getElementById('btnClear');
  const btnLoadMore = document.getElementById('btnLoadMore');
  const list = document.getElementById('list');

  function updateLoadMoreVisibility(filtered){
    if(!btnLoadMore) return;
    btnLoadMore.style.display = filtered.length > renderedCount ? 'inline-block' : 'none';
  }

  if(btnApply) btnApply.addEventListener('click', ()=>{
    const city = document.getElementById('f-city')?.value.trim()||'';
    const type = document.getElementById('f-type')?.value||'';
    const min = document.getElementById('f-min')?.value||'';
    const max = document.getElementById('f-max')?.value||'';
    const sort = document.getElementById('f-sort')?.value||'relevance';
    const filtered = applyFilters({city,type,min,max,sort});
    renderedCount = Math.min(PAGE_SIZE, filtered.length);
    list.dataset.filtered = JSON.stringify(filtered);
    renderList(filtered.slice(0, renderedCount), true);
    updateLoadMoreVisibility(filtered);
  });

  if(btnClear) btnClear.addEventListener('click', ()=>{
    document.getElementById('f-city').value='';
    document.getElementById('f-type').value='';
    document.getElementById('f-min').value='';
    document.getElementById('f-max').value='';
    document.getElementById('f-sort').value='relevance';
    renderedCount = Math.min(PAGE_SIZE, sampleProperties.length);
    list.dataset.filtered = JSON.stringify(sampleProperties);
    renderList(sampleProperties.slice(0, renderedCount), true);
    updateLoadMoreVisibility(sampleProperties);
  });

  if(btnLoadMore) btnLoadMore.addEventListener('click', ()=>{
    let filtered = [];
    try{ filtered = JSON.parse(list.dataset.filtered||'null') || sampleProperties; }catch(e){ filtered = sampleProperties; }
    const next = filtered.slice(renderedCount, renderedCount + PAGE_SIZE);
    renderList(next, false);
    renderedCount += next.length;
    updateLoadMoreVisibility(filtered);
  });

  /*
    Carga inicial de propiedades. Se usa una ruta absoluta a ``/properties/data.json`` para
    garantizar que el JSON se resuelva correctamente sin importar la ubicación de la página.
    La función initProperties se ejecuta cuando la página y el DOM están listos. Si el archivo no
    existe o se produce un error, simplemente se mantiene la lista vacía y se oculta el
    botón "Cargar más". Los errores se imprimen en la consola para facilitar el diagnóstico.
  */
  async function initProperties(){
    try {
      const response = await fetch('/properties/data.json');
      if(!response.ok) throw new Error('No se pudo obtener el JSON');
      const allProps = await response.json();
      // Filtrar por operación ("comprar")
      sampleProperties = Array.isArray(allProps) ? allProps.filter(p => p.operation === operation) : [];
    } catch(err){
      console.error('Error loading properties:', err);
      sampleProperties = [];
    }
    renderedCount = Math.min(PAGE_SIZE, sampleProperties.length);
    list.dataset.filtered = JSON.stringify(sampleProperties);
    renderList(sampleProperties.slice(0, renderedCount), true);
    updateLoadMoreVisibility(sampleProperties);
  }
  // Ejecutar al cargar completamente la página para asegurar que los elementos existan
  window.addEventListener('load', initProperties);

  /* ---------------- MODAL CONTACTO + Google Forms mapping ---------------- */
  const leadBackdrop = document.getElementById('leadBackdrop');
  const leadModal = document.getElementById('leadModal');
  const leadForm = document.getElementById('leadForm');
  const leadSubmit = document.getElementById('leadSubmit');
  const leadCancel = document.getElementById('leadCancel');
  const leadClose = leadModal.querySelector('.close');
  const leadDate = document.getElementById('lead-date');

  const leadConfig = {
    enabled: false, // activar true si pegas formAction y fields
    formAction: "https://docs.google.com/forms/d/e/FORM_ID_REAL/formResponse",
    entries: {
      name:     "entry.1111111111",
      phone:    "entry.2222222222",
      email:    "entry.3333333333",
      date:     "entry.4444444444",
      property: "entry.5555555555",
      url:      "entry.6666666666",
      message:  "entry.7777777777"
    },
    demo:false
  };

  function nowLocalISO(){
    const d = new Date();
    const pad = n=> String(n).padStart(2,'0');
    return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+"T"+pad(d.getHours())+":"+pad(d.getMinutes());
  }
  if(leadDate) leadDate.value = nowLocalISO();

  let lastFocus = null;
  function openLeadModal(prop){
    lastFocus = document.activeElement;
    document.getElementById('lead-property').value = `${prop.title} — ${prop.city} — ${capitalize(prop.type)} — $${formatCOP(prop.price)} COP (ID ${prop.id})`;
    document.getElementById('lead-url').value = prop.url;
    leadModal.hidden = false;
    leadBackdrop.classList.add('open');
    leadModal.classList.add('open');
    setTimeout(()=> document.getElementById('lead-name').focus(), 0);
    document.body.style.overflow='hidden';
  }
  function closeLeadModal(){
    leadBackdrop.classList.remove('open');
    leadModal.classList.remove('open');
    document.body.style.overflow='';
    setTimeout(()=>{ leadModal.hidden = true; }, 160);
    lastFocus && lastFocus.focus();
    leadForm.reset();
    document.getElementById('lead-date').value = nowLocalISO();
  }
  leadCancel.addEventListener('click', closeLeadModal);
  leadClose.addEventListener('click', closeLeadModal);
  leadBackdrop.addEventListener('click', closeLeadModal);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !leadModal.hidden) closeLeadModal(); });

  function buildMailto(){
    const name = document.getElementById('lead-name').value.trim();
    const phone= document.getElementById('lead-phone').value.trim();
    const email= document.getElementById('lead-email').value.trim();
    const date = document.getElementById('lead-date').value;
    const prop = document.getElementById('lead-property').value;
    const url  = document.getElementById('lead-url').value;
    const msg  = document.getElementById('lead-message').value.trim();
    const subject = `Interés en propiedad — ${prop}`;
    const body = `Fecha: ${date}\nNombre: ${name}\nTeléfono: ${phone}\nCorreo: ${email}\nPropiedad: ${prop}\nURL: ${url}\n\nMensaje:\n${msg}\n`;
    return `mailto:ventas@altorra.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }

  function mapToGoogleForm(){
    const e = leadConfig.entries;
    const map = [
      {src:'lead-name',     hid:'g-name',     name:e.name},
      {src:'lead-phone',    hid:'g-phone',    name:e.phone},
      {src:'lead-email',    hid:'g-email',    name:e.email},
      {src:'lead-date',     hid:'g-date',     name:e.date},
      {src:'lead-property', hid:'g-property', name:e.property},
      {src:'lead-url',      hid:'g-url',      name:e.url},
      {src:'lead-message',  hid:'g-message',  name:e.message},
    ];
    map.forEach(m=>{
      const src = document.getElementById(m.src);
      const hid = document.getElementById(m.hid);
      if(!hid || !src) return;
      hid.name = m.name;
      hid.value = src.value;
    });
    leadForm.action = leadConfig.formAction;
  }

  let submitting = false;
  document.getElementById('leadTarget').addEventListener('load', ()=>{
    if(!submitting) return;
    submitting = false;
    try { alert('¡Gracias! Hemos recibido tu solicitud. Te contactaremos pronto.'); }
    catch(e){}
    closeLeadModal();
  });

  leadSubmit.addEventListener('click', ()=>{
    if(!leadForm.reportValidity()) return;
    if(leadConfig.enabled && !leadConfig.demo){
      mapToGoogleForm();
      submitting = true;
      leadForm.submit();
    }else if(leadConfig.demo){
      console.log('[DEMO] Enviando a Google Forms:', {
        action: leadConfig.formAction, entries: leadConfig.entries
      });
      alert('DEMO: Datos validados. Configura formAction y entries para enviar a Google Forms.');
      closeLeadModal();
    }else{
      // fallback por mailto
      window.location.href = buildMailto();
      closeLeadModal();
    }
  });

  // Exponer para tarjetas
  window.openLeadModal = openLeadModal;
});
<script>
(function(){
  try{
    const params = new URLSearchParams(location.search);
    const city = params.get('city') || '';
    const type = params.get('type') || '';
    const min  = params.get('min')  || '';
    const max  = params.get('max')  || '';
    const q    = params.get('q')    || '';

    // Si no vienen por URL, intentar leer lo guardado por el home
    if(!city && !type && !min && !max && !q){
      try{
        const last = JSON.parse(localStorage.getItem('altorra_last_search') || '{}');
        if(last){
          if(!city) params.set('city', last.city || '');
          if(!type) params.set('type', last.type || '');
          if(!min)  params.set('min', last.min || '');
          if(!max)  params.set('max', last.max || '');
        }
      }catch(e){}
    }

    // Aplicar valores a los inputs si existen
    window.addEventListener('DOMContentLoaded', function(){
      if(document.getElementById('f-city') && params.get('city')) document.getElementById('f-city').value = params.get('city');
      if(document.getElementById('f-type') && params.get('type')) document.getElementById('f-type').value = params.get('type');
      if(document.getElementById('f-min')  && params.get('min'))  document.getElementById('f-min').value  = params.get('min');
      if(document.getElementById('f-max')  && params.get('max'))  document.getElementById('f-max').value  = params.get('max');

      // pequeña espera para asegurar que los handlers y sampleProperties ya estén disponibles
      if(params.get('city') || params.get('type') || params.get('min') || params.get('max') || params.get('q')){
        setTimeout(function(){
          const btn = document.getElementById('btnApply');
          if(btn) btn.click();
        }, 80);
      }
    });
  }catch(e){ console.warn('sync snippet error', e); }
})();

  </script>
</body>
</html>
